name: Deploy — mcp.octopilot.app

on:
  push:
    branches: [main]
    tags: ["v*"]
    paths:
      - "src/**"
      - "pyproject.toml"
      - "install.sh"
      - "site/**"
      - ".github/workflows/deploy-mcp.yml"
  workflow_dispatch:

# Allow one deploy to run at a time; don't cancel mid-flight.
concurrency:
  group: deploy-mcp
  cancel-in-progress: false

permissions:
  contents: write   # GitHub Releases
  pages: write      # GitHub Pages deploy
  id-token: write   # PyPI OIDC trusted publishing

jobs:
  # ── 1. Tests must pass before any deploy ────────────────────────────────────
  test:
    name: Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -e ".[dev]" --quiet
      - run: ruff check src/ tests/
      - run: ruff format src/ tests/ --check
      - run: pytest tests/ -q

  # ── 2. Build the static site ─────────────────────────────────────────────────
  build-site:
    name: Build static site
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: site/package-lock.json

      - name: Install site dependencies
        run: npm ci
        working-directory: site

      # Fetch the latest actions.json from octopilot.app and bundle it
      # into the static site so /actions.json always reflects the live registry.
      - name: Fetch actions registry
        run: |
          curl -sf --max-time 15 https://octopilot.app/actions.json \
               -o site/public/actions.json \
            || echo '{"version":"1","actions":[]}' > site/public/actions.json
          echo "actions.json: $(wc -c < site/public/actions.json) bytes"

      - name: Build site
        run: npm run build
        working-directory: site

      # Upload the built site as a Pages artifact
      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: site/dist

  # ── 3. Deploy to GitHub Pages (mcp.octopilot.app) ────────────────────────────
  deploy-pages:
    name: Deploy to GitHub Pages
    needs: build-site
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4

  # ── 4. Publish to PyPI + GitHub Releases (tags only) ─────────────────────────
  publish:
    name: Publish to PyPI + GitHub Releases
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    environment: pypi
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build wheel and sdist
        run: |
          pip install build --quiet
          python -m build
          echo "Built packages:"
          ls -lh dist/

      # Publish to PyPI via OIDC trusted publishing — no API token needed.
      # Set up the trusted publisher at:
      #   https://pypi.org/manage/project/octopilot-mcp/settings/publishing/
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      # Attach the wheel to the GitHub Release for direct URL installs.
      - name: Upload wheel to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.whl
          tag_name: ${{ github.ref_name }}
          body: |
            ## Install

            ```bash
            # One-line installer (recommended)
            curl -fsSL https://mcp.octopilot.app/install.sh | sh

            # PyPI
            uv tool install octopilot-mcp

            # Direct from this release
            uv tool install "https://github.com/octopilot/octopilot-mcp/releases/download/${{ github.ref_name }}/$(ls dist/*.whl | xargs basename)"
            ```

            ## What's new
            See [CHANGELOG](https://github.com/octopilot/octopilot-mcp/blob/main/CHANGELOG.md) for details.
